<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="../recursos/audio/favicon.ico"
      type="image/x-icon"
    />
    <title>SuperNetos - Resultados</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Italiana&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap");

      * {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      @font-face {
        font-family: "Material Symbols Rounded";
        font-style: normal;
        font-weight: 400;
        src: url(https://fonts.gstatic.com/s/materialsymbolsrounded/v226/syl0-zNym6YjUruM-QrEh7-nyTnjDwKNJ_190FjpZIvDmUSVOK7BDB_Qb9vUSzq3wzLK-P0J-V_Zs-QtQth3-jOcbTCVpeRL2w5rwZu2rIelXxc.woff2)
          format("woff2");
      }

      .material-symbols-rounded {
        font-family: "Material Symbols Rounded";
        font-weight: normal;
        font-style: normal;
        font-size: auto;
        line-height: 1;
        letter-spacing: normal;
        text-transform: none;
        display: inline-block;
        white-space: nowrap;
        word-wrap: normal;
        direction: ltr;
        font-feature-settings: "liga";
        -moz-font-feature-settings: "liga";
        -moz-osx-font-smoothing: grayscale;
      }

      #screen_rotation_icon {
        font-size: 64px;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: black;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Roboto", serif;
        color: white; /* Adiciona cor branca ao texto */
      }

      #box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        aspect-ratio: 16/9;
        width: 100%;
        height: 100%;
        box-sizing: border-box;

        background-image: url("../recursos/imagens/interface/background.jpg");
        background-size: cover;
        /* Ajusta a imagem para cobrir a div */
        background-position: center;
        /* Centraliza a imagem */
        background-repeat: no-repeat;
        /* Impede repeti√ß√£o */
      }

      @media (min-aspect-ratio: 16/9) {
        #box {
          /* horizontal */
          width: auto;
          height: 100vh;
        }

        #overlay {
          display: none;
        }
      }

      @media (max-aspect-ratio: 16/9) {
        #box {
          /* vertical */
          width: 100vw;
          height: auto;
        }
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgb(49, 49, 49);
        color: white;
        text-align: center;
        font-size: 1.5em;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      @media (max-aspect-ratio: 0.999/1) {
        .overlay {
          display: flex;
        }

        #box {
          display: none;
        }
      }

      #rectangle2 {
        position: absolute;
        width: 65vw;
        /* Ajust√°vel conforme tela */
        height: 45vw;
        /* Mant√©m propor√ß√£o */
        background-color: #b8daf0;
        border-radius: 4vw;
        /* Mant√©m cantos arredondados proporcionais */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
      }

      #rectangle1 {
        position: absolute;
        width: calc(65vw - 3vh);
        /* 3px menor proporcionalmente */
        height: 45vw;
        background-color: #c8e9ff;
        border-radius: 4vw;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        overflow: hidden;

        /* Adiciona o brilho no topo */
        background: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.5) 0%,
            rgba(255, 255, 255, 0) 20%
          ),
          #c8e9ff;

        /* Sombra externa */
        box-shadow: 0px 1vw 2vw rgba(0, 0, 0, 0.25);
      }

      #content {
        width: 100%;
        height: 100%;
        border-radius: 4vw;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: whitesmoke;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        padding: 2vh 3vw;
        box-sizing: border-box;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        z-index: 2;
      }

      .result-title {
        font-size: 1.8em;
        margin-bottom: 0.5em;
        word-wrap: break-word;
        max-width: 100%;
      }

      .confetti-gif {
        position: absolute;
        width: 90%;
        height: 90%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 3vw;
        z-index: 1;
        opacity: 1;
        object-fit: cover;
      }

      .result-illustration {
        width: 100%;
        height: 15vh;
        background-size: cover;
        background-position: center;
        border-radius: 2vw;
        margin-bottom: 1vh;
      }

      .result-text {
        font-size: 1.2em;
        margin-bottom: 1vh;
        word-wrap: break-word;
        max-width: 100%;
        line-height: 1.4;
      }

      #game-progress {
        font-size: 1em;
        margin-bottom: 1.5vh;
        word-wrap: break-word;
        max-width: 100%;
        line-height: 1.3;
      }

      #game-progress h3 {
        font-size: 1.3em;
        margin: 1vh 0;
      }

      #game-progress p {
        margin: 0.5vh 0;
        font-size: 0.9em;
      }

      .restart-button {
        padding: 1.5vh 3vw;
        font-size: 1em;
        border: none;
        border-radius: 2vw;
        background-color: #00c853;
        color: white;
        cursor: pointer;
        min-height: 5vh;
        font-weight: bold;
        transition: background-color 0.3s;
      }

      .restart-button:hover {
        background-color: #00a142;
      }

      .export-button {
        padding: 1vh 2vw;
        font-size: 0.8em;
        border: none;
        border-radius: 2vw;
        background-color: #2196f3;
        color: white;
        cursor: pointer;
        min-height: 4vh;
        font-weight: bold;
        transition: background-color 0.3s;
      }

      .export-button:hover {
        background-color: #1976d2;
      }

      .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3vh;
        margin-top: 2vh;
      }
    </style>
  </head>
  <body>
    <!-- Elemento de √°udio para continuidade da m√∫sica de fundo -->
    <audio
      id="bg-music"
      src="../recursos/audio/background_music.mp3"
      loop
    ></audio>

    <div class="overlay">
      <span class="material-symbols-rounded" id="screen_rotation_icon"
        >screen_rotation</span
      >
      <p>Vire a tela na horizontal</p>
    </div>
    <div id="box">
      <div id="rectangle1">
        <img
          src="../recursos/imagens/interface/parabens_confete.gif"
          alt="Parab√©ns!"
          class="confetti-gif"
          id="confetti-gif"
        />
        <div id="content">
          <div id="game-progress"></div>
          <div class="result-text" id="result-message">
            Carregando resultados...
          </div>
          <div class="button-container">
            <button class="restart-button" onclick="restartGame()">
              JOGAR NOVAMENTE
            </button>
            <button class="export-button" onclick="exportarResultados()">
              üìä EXPORTAR CSV
            </button>
          </div>
        </div>
      </div>
      <div id="rectangle2"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Gerenciamento de √°udio de fundo - manter consist√™ncia
        const audio = document.getElementById("bg-music");
        if (audio) {
          audio.volume = 0.3;
          const isMuted = localStorage.getItem("bgMusicMuted") === "1";
          audio.muted = isMuted;

          if (!isMuted && localStorage.getItem("bgMusicStarted") === "1") {
            const savedTime = parseFloat(
              localStorage.getItem("bgMusicTime") || "0"
            );
            audio.currentTime = isNaN(savedTime) ? 0 : savedTime;
            audio.play().catch(() => {});
          }
        }

        // Retrieve game progress and total attempts from localStorage
        const gameProgress =
          JSON.parse(localStorage.getItem("gameProgress")) || [];

        // Tentar carregar dados do finalScore primeiro (sistema din√¢mico)
        const finalScore =
          JSON.parse(localStorage.getItem("finalScore")) || null;
        let totalAttempts = 0;

        if (finalScore) {
          // Usar dados do sistema din√¢mico
          totalAttempts = finalScore.tentativas || 0;
        } else {
          // Fallback para sistema antigo
          totalAttempts = parseInt(localStorage.getItem("totalAttempts")) || 0;
        }

        const gameProgressElement = document.getElementById("game-progress");
        const resultMessageElement = document.getElementById("result-message");

        // Display final score summary if available
        if (finalScore) {
          let summaryHTML = `
            <h3>üéØ Resultado Final</h3>
            <p><strong>Acertos:</strong> ${finalScore.acertos}/${finalScore.total}</p>
            <p><strong>Pontua√ß√£o:</strong> ${finalScore.percentual}%</p>
            <p><strong>Tentativas:</strong> ${finalScore.tentativas}</p>
            <hr style="margin: 1.5vh 0; border-color: #fcfc00; opacity: 0.7;">
          `;
          gameProgressElement.innerHTML =
            summaryHTML + (gameProgressElement.innerHTML || "");
        }

        // Display game progress
        if (gameProgress.length > 0) {
          let progressHTML = "<h3>üìä Detalhes</h3>";
          gameProgress.forEach((item, index) => {
            progressHTML += `
                        <p>
                            P${item.pergunta}: ${
              item.resposta === 1 ? "‚úÖ Sim" : "‚ùå N√£o"
            }
                        </p>
                    `;
          });

          if (!finalScore) {
            // S√≥ mostrar tentativas se n√£o tiver finalScore
            gameProgressElement.innerHTML = progressHTML;
          } else {
            // Adicionar progresso detalhado ao resumo
            gameProgressElement.innerHTML += progressHTML;
          }

          // Determine result message
          if (finalScore) {
            // Usar dados do sistema din√¢mico
            if (finalScore.percentual >= 70) {
              resultMessageElement.innerHTML = `
                <h2>üéâ PARAB√âNS!</h2>
                <p>Excelente desempenho!</p>
              `;
            } else if (finalScore.percentual >= 50) {
              resultMessageElement.innerHTML = `
                <h2>üòä BOM TRABALHO!</h2>
                <p>Voc√™ pode melhorar!</p>
              `;
            } else {
              resultMessageElement.innerHTML = `
                <h2>ü§î TENTE NOVAMENTE!</h2>
                <p>Na pr√≥xima voc√™ consegue!</p>
              `;
            }
          } else if (gameProgress.length > 0) {
            // L√≥gica original para compatibilidade
            const firstQuestion = gameProgress[0];
            if (firstQuestion.resposta === 0) {
              resultMessageElement.innerHTML = `<h2>üéâ PARAB√âNS!</h2><p>Voc√™ acertou!</p>`;
            } else {
              resultMessageElement.innerHTML = `<h2>ü§î TENTE NOVAMENTE!</h2><p>Voc√™ errou!</p>`;
            }
          }
        } else {
          if (finalScore) {
            // Mostrar resultado mesmo sem progresso detalhado
            gameProgressElement.innerHTML = `
              <h3>üéØ Resultado Final</h3>
              <p><strong>Acertos:</strong> ${finalScore.acertos}/${finalScore.total}</p>
              <p><strong>Pontua√ß√£o:</strong> ${finalScore.percentual}%</p>
              <p><strong>Tentativas:</strong> ${finalScore.tentativas}</p>
            `;

            if (finalScore.percentual >= 70) {
              resultMessageElement.innerHTML = `
                <h2>üéâ PARAB√âNS!</h2>
                <p>Excelente desempenho!</p>
              `;
            } else {
              resultMessageElement.innerHTML = `
                <h2>üòä BOM TRABALHO!</h2>
                <p>Continue praticando!</p>
              `;
            }
          } else {
            gameProgressElement.innerHTML = "<p>üìä Sem dados do jogo</p>";
            resultMessageElement.innerHTML = "<h2>üéÆ Comece um novo jogo!</h2>";
          }
        }
      });

      function restartGame() {
        // Clear all game progress and data
        localStorage.removeItem("gameProgress");
        localStorage.removeItem("totalAttempts");
        localStorage.removeItem("selectedCharacter");
        localStorage.removeItem("progressoJogo");
        localStorage.removeItem("totalTentativas");
        localStorage.removeItem("personagemSelecionado");
        localStorage.removeItem("personagemEscolhido");
        localStorage.removeItem("finalScore");
        localStorage.removeItem("playerName");
        localStorage.removeItem("nomeJogador");

        // Redirect to the main game page
        window.location.href = "../../index.html";
      }

      function exportarResultados() {
        // Recuperar dados do localStorage
        const gameProgress =
          JSON.parse(localStorage.getItem("gameProgress")) || [];
        const finalScore =
          JSON.parse(localStorage.getItem("finalScore")) || null;
        // Tentar ambas as chaves para compatibilidade
        const personagemSelecionado =
          localStorage.getItem("selectedCharacter") ||
          localStorage.getItem("personagemEscolhido") ||
          "N√£o informado";
        const nomeJogador =
          localStorage.getItem("playerName") ||
          localStorage.getItem("nomeJogador") ||
          "N√£o informado";

        // Preparar dados para CSV
        let csvContent = "data:text/csv;charset=utf-8,";

        // Cabe√ßalho do CSV
        csvContent += "SuperNetos - Resultados do Jogo\n";
        csvContent += "Data/Hora," + new Date().toLocaleString("pt-BR") + "\n";
        csvContent += "Nome do Jogador," + nomeJogador + "\n";
        csvContent += "Personagem Escolhido," + personagemSelecionado + "\n\n";
        if (finalScore) {
          // Resumo final
          csvContent += "RESUMO FINAL\n";
          csvContent += "Total de Perguntas," + finalScore.total + "\n";
          csvContent += "Acertos," + finalScore.acertos + "\n";
          csvContent +=
            "Erros," + (finalScore.total - finalScore.acertos) + "\n";
          csvContent += "Percentual de Acerto," + finalScore.percentual + "%\n";
          csvContent += "Total de Tentativas," + finalScore.tentativas + "\n\n";
        }

        if (gameProgress.length > 0) {
          // Detalhes por pergunta
          csvContent += "DETALHES POR PERGUNTA\n";
          csvContent += "Numero da Pergunta,Resposta Dada,Status\n";

          gameProgress.forEach((item) => {
            const resposta = item.resposta === 1 ? "Sim" : "N√£o";
            const status = item.resposta === 1 ? "Correto" : "Incorreto";
            csvContent += item.pergunta + "," + resposta + "," + status + "\n";
          });
        } else {
          csvContent += "PROGRESSO DETALHADO\n";
          csvContent += "Nenhum dado de progresso encontrado\n";
        }

        // Adicionar estat√≠sticas adicionais
        csvContent += "\nESTAT√çSTICAS\n";
        if (finalScore) {
          const eficiencia =
            finalScore.tentativas > 0
              ? ((finalScore.acertos / finalScore.tentativas) * 100).toFixed(1)
              : 0;
          csvContent += "Efici√™ncia (Acertos/Tentativas)," + eficiencia + "%\n";
          csvContent +=
            "M√©dia de Tentativas por Pergunta," +
            (finalScore.tentativas / finalScore.total).toFixed(1) +
            "\n";
        }

        // Gerar nome do arquivo com data/hora
        const agora = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const timestamp =
          agora.getFullYear().toString() +
          pad(agora.getMonth() + 1) +
          pad(agora.getDate()) +
          "_" +
          pad(agora.getHours()) +
          pad(agora.getMinutes()) +
          pad(agora.getSeconds());
        const nomeArquivo = "SuperNetos_Resultados_" + timestamp + ".csv";

        // Criar e baixar o arquivo
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", nomeArquivo);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Feedback visual
        const exportButton = document.querySelector(".export-button");
        const textoOriginal = exportButton.innerHTML;
        exportButton.innerHTML = "‚úÖ EXPORTADO!";
        exportButton.style.backgroundColor = "#4caf50";

        setTimeout(() => {
          exportButton.innerHTML = textoOriginal;
          exportButton.style.backgroundColor = "#2196f3";
        }, 2000);
      }
    </script>
  </body>
</html>
